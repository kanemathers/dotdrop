#!/bin/bash
# dotdrop
# =======
#
# Keep your dotfiles nsync with the dropbox as the backup dancer.
# https://github.com/kanemathers/dotdrop
#
# How to Install
# --------------
#
# Source this file in ~/.bash_profile::
#
#     $ echo "[[ -f ~/Dropbox/dotdrop/dotdrop ]] && source ~/Dropbox/dotdrop/dotdrop" >> ~/.bash_profile
#

[[ -f ~/Dropbox/dotdrop/sync ]] && . ~/Dropbox/dotdrop/sync

HERE=$(cd $(dirname "${BASH_SOURCE[0]}") && pwd -P)
DOTDROP_SLEEP=${DOTDROP_SLEEP:-10}
DOTDROP_NOTIFY=${DOTDROP_NOTIFY:-"no"}

dotdrop_notify()
{
    local message=$1

    if [[ "$DOTDROP_NOTIFY" != "yes" ]]; then
        return 0
    fi

    if [[ -z "$message" ]]; then
        return 1
    fi

    command -v notify-send >/dev/null 2>&1 || return 1

    notify-send "$message"

    return $?
}

dotdrop_sync()
{
    # Sleep long enough for an internet connection to be established and,
    # hopefully, long enough for dropbox to sync the plugins.
    sleep $DOTDROP_SLEEP

    remove_links

    for plugin in "$HERE"/plugins.d/*/*; do
        create_link "$plugin"
    done

    dotdrop_notify "dotdrop: finished syncing"
}

(dotdrop_sync &)
